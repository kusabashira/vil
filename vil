#! /bin/sh
set -eu
version='v0.1.0'

usage() {
  cat <<__USAGE__ 1>&2
Usage: ${0##*/} [OPTION]... PROGRAM [FILE]...
Edit text with Vim script.

Options:
      --help     display this help and exit
      --version  output version information and exit
__USAGE__
}

version() {
  echo "$version" 1>&2
}

script="$(mktemp)"
src="$(mktemp)"
trap 'rm '$script' '$src EXIT

require_program=1
while [ "$#" -gt 0 ]; do
  case "$1" in
    --help)
      usage
      exit 0
      ;;
    --version)
      version
      exit 0
      ;;
    -f|--file)
      if [ "$#" -lt 2 ]; then
        echo "${0##*/}: option requires an argument -- '${1##*-}'"
        exit 2
      fi
      cat "$2" >> "$script"
      require_program=0
      shift
      ;;
    *)
      break
      ;;
  esac
  shift
done
if [ "$require_program" -eq 1 ]; then
  if [ "$#" -lt 1 ]; then
    echo "Usage: ${0##*/} [OPTION]... PROGRAM [FILE]..."  1>&2
    exit 2
  fi
  echo "$1" >> "$script"
  shift
fi
echo "%print" >> "$script"
echo "exit" >> "$script"

cat -- "$@" > "$src"
vim -u NONE -i NONE -N -n -e -s -S "$script" "$src"
